<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpellVoc - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root { --nav-h: 60px; --sb-w: 240px; }
        body { margin: 0; }
        .dash-navbar { position: fixed; top:0; left:0; right:0; height:var(--nav-h); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:space-between; padding:0 16px; color:#fff; z-index:30; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .dash-brand { font-weight:800; letter-spacing:.4px; }
        .dash-userarea { display:flex; align-items:center; gap:10px; position:relative; }
        .dash-avatar { width:36px; height:36px; border-radius:50%; background:#fff; color:#764ba2; display:flex; align-items:center; justify-content:center; font-weight:800; }
        .dash-username { font-weight:700; }
        .dash-email-tooltip { position:absolute; top:46px; right:0; background:#fff; color:#333; border-radius:8px; padding:8px 10px; box-shadow:0 8px 20px rgba(0,0,0,0.15); font-size:0.9rem; display:none; white-space:nowrap; }
        .dash-userarea:hover .dash-email-tooltip { display:block; }
        .power-btn { background:#e74c3c; color:#fff; border:none; border-radius:8px; padding:0.45rem 0.8rem; cursor:pointer; font-weight:700; }
        .dash-shell { display:flex; }
        .dash-sidebar { position:fixed; top:var(--nav-h); left:0; bottom:0; width:var(--sb-w); background:#faf8f5; border-right:1px solid #eee; padding:14px; overflow:auto; }
        .dash-sidebar a { display:block; padding:10px 12px; color:#444; text-decoration:none; border-radius:8px; margin-bottom:6px; }
        .dash-sidebar a:hover { background:#efeaf8; color:#5a3ba2; }
        .dash-main { margin-top:var(--nav-h); margin-left:var(--sb-w); padding:24px; min-height:calc(100vh - var(--nav-h)); }
        .card { background:#f8f9fa; border-radius:12px; padding:1rem 1.2rem; box-shadow:0 4px 10px rgba(0,0,0,0.04); }
        .error-box { background:#fff5f5; color:#a94442; border:1px solid #f5c2c2; border-radius:10px; padding:10px 12px; }
        pre { white-space:pre-wrap; word-break:break-word; }
        @media (max-width: 900px) { :root { --sb-w: 0px; } .dash-sidebar { display:none; } .dash-main { margin-left:0; } }
    </style>
</head>
<body>
    <nav class="dash-navbar">
        <div class="dash-brand">SpellVoc Dashboard</div>
        <div class="dash-userarea">
            <div class="dash-avatar" id="dashAvatar">U</div>
            <div class="dash-username" id="dashUserName">User</div>
            <button id="logoutBtn" class="power-btn">⏻ Logout</button>
            <div class="dash-email-tooltip" id="dashEmailTip">user@example.com</div>
        </div>
    </nav>

    <div class="dash-shell">
        <aside class="dash-sidebar">
            <a href="#overview">Overview</a>
            <a href="#trials">My Trials</a>
            <a href="#reservations">Reservations</a>
            <a href="#courses">Courses</a>
        </aside>
        <main class="dash-main">
            <h2 id="overview">Overview</h2>
            <div id="dashStatus" style="margin:1rem 0; color:#555;">Loading...</div>
            <div class="card" id="authError" style="display:none;">
                <div class="error-box">
                    <div style="font-weight:700; margin-bottom:6px;">You are not logged in</div>
                    <div id="lastLoginHint" style="font-size:0.95rem;">Last attempted login: —</div>
                    <div style="margin-top:8px;">
                        <a href="index.html" class="signup-btn" style="width:auto; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">Go to Login</a>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>User Profile</h3>
                <pre id="profileJson">{}</pre>
            </div>
        </main>
    </div>

    <script>
    const API_BASE = 'http://localhost:4000';
    async function api(path, opts={}){
        const res = await fetch(API_BASE + path, { credentials: 'include', headers: { 'Content-Type':'application/json' }, ...opts });
        let data = null; try { data = await res.json(); } catch(_){ }
        if (!res.ok) throw new Error((data && (data.error||data.message)) || ('HTTP '+res.status));
        return data;
    }

    function initials(name){
        if (!name) return 'U';
        const parts = name.trim().split(/\s+/).slice(0,2);
        return parts.map(p=>p[0]?.toUpperCase()||'').join('') || 'U';
    }

    async function loadProfile(){
        const status = document.getElementById('dashStatus');
        const pre = document.getElementById('profileJson');
        const avatar = document.getElementById('dashAvatar');
        const uname = document.getElementById('dashUserName');
        const emailTip = document.getElementById('dashEmailTip');
        const authError = document.getElementById('authError');
        const lastHint = document.getElementById('lastLoginHint');
        try {
            status.textContent = 'Loading profile...';
            const me = await api('/api/auth/me');
            pre.textContent = JSON.stringify(me, null, 2);
            status.textContent = 'Logged in';
            authError.style.display = 'none';
            avatar.textContent = initials(me.fullName);
            uname.textContent = me.fullName || 'User';
            emailTip.textContent = me.email || '';
        } catch (e) {
            status.textContent = '';
            authError.style.display = 'block';
            const last = localStorage.getItem('last_login_email') || '—';
            lastHint.textContent = 'Last attempted login: ' + last;
            pre.textContent = '{}';
            avatar.textContent = 'U';
            uname.textContent = 'Guest';
            emailTip.textContent = '';
        }
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try { await api('/api/auth/logout', { method: 'POST' }); } catch(e){}
        window.location.href = 'index.html';
    });

    loadProfile();
    </script>
</body>
</html>